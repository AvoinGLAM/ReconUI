<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Full Screen Interface</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            font-family: Arial, sans-serif;
        }
        .container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 50px;
            background-color: #f0f0f0;
            padding: 0 10px;
        }
        .section-2 {
            height: 50px;
            display: flex;
            align-items: center;
            padding: 0 10px;
            background-color: #e0e0e0;
        }
        .section-2 input {
            height: 25px;
            margin-right: 10px;
        }
        .section-2 button {
            height: 25px;
            margin-right: 10px;
        }
        .content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        .left-pane {
            width: 33%;
            background-color: #d0d0d0;
            overflow-y: auto;
            padding: 10px;
        }
        .introduction-help {
            padding: 20px;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .introduction-help h2 {
            margin-top: 0;
        }

        .introduction-help button {
            margin-top: 10px;
        }
        .item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #ccc;
            cursor: pointer;
            background-color: white;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .item.selected {
            background-color: #1EACFC;
            color: white;
        }
        .item img {
            width: 50px;
            height: 50px;
            margin-right: 10px;
            border-radius: 5px;
        }
        .item-details {
            flex: 1;
        }
        .item-details .qid-link, #projectUrl {
            color: #1EACFC;
            text-decoration: none;
        }
        .item-details a:hover {
            text-decoration: underline;
        }
        .right-pane {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            background: #e0e0e0;
        }
        .component {
            background-color: white;
            display: flex;
            flex-direction: column;
        }
        .component-header {
            height: 80px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .component-header-top {
            display: flex;
            justify-content: space-between;
        }
        .component-header-top select {
            font-size: 1.2em;
            border: none;
            background: none;
            font-weight: bold;
        }
        .component-header-bottom {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .component-header-bottom .row {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9em;
        }
        .component-header-bottom .row select {
            border: none;
            font-size: 0.9em;

        }
        .component-header-bottom .row input {
            height: 15px;
            font-size: 0.9em;
            flex: 1;
        }
        .component-body {
            flex: 1;
        }
        #map {
            width: 100%;
            height: 100%;
            background-color: #f0f0f0;
        }
        /* Style for popup links */
        a.popup-link {
            color: #1EACFC;
            text-decoration: none;
        }
        a.popup-link:hover {
            text-decoration: underline;
        }
        /* Style for item links */
        .item .qid-link {
            color: #1EACFC;
            text-decoration: none;
        }
        .item .qid-link:hover {
            text-decoration: underline;
        }

        /* Style for selected items */
        .item.selected {
            background-color: #1EACFC; /* Background color for selected item */
            color: white;
        }

        /* Ensure links in selected items remain visible */
        .item.selected .qid-link {
            color: #FFFFFF; /* White or another color that stands out */
        }


    </style>
</head>
<body>
    <div class="container">
        <div class="top-bar">
            <div>
                <button id="prevButton">Previous</button>
                <button id="nextButton">Next</button>
            </div>
            <div>
                <button>Close</button>
            </div>
        </div>        
        <div class="section-2">
            <input type="text" id="searchInput" placeholder="Input here">
            <button id="searchButton">Submit</button>
            <button>Don't reconcile cell</button>
            <button>New item</button>
        </div>
        <div class="content">
            <div class="left-pane" id="itemList">
                <div class="introduction-help">
                    <h2>Introduction</h2>
                    <p>Welcome to try this reconciliation interface experiment!</p>
                    <p>The goal is to create a set of interfaces that display Wikidata reconciliation candidates in many informative ways using more of the data available in the different sources.</p>
                    <p>At the moment, you can type in individual search terms and get results based on Wikidata's Action API via SPARQL. Later, perhaps, multiple search methods can be combined.</p>
                    <p>Ideally, this interface could sit on top of any data wrangling tool, read the items to be reconciled and return the reconciled items in the simplest form.</p>
                    <button id="showHelpButton">Show Help</button>
                    <div id="helpSection" style="display: none;">
                        <h3>Help</h3>
                        <p>If you need assistance, please follow the steps below:</p>
                        <ul>
                            <li>Use the "Submit" button to search for items.</li>
                            <li>Navigate between items using the "Previous" and "Next" buttons.</li>
                            <li>Click on the dropdown menus to switch views or settings.</li>
                        </ul>
                    </div>
                </div>
                <!-- Items will be populated here by JavaScript -->
            </div>
            <div class="right-pane">
                <div class="component" id="leftcomponent">
                    <div class="component-header">
                        <div class="component-header-top">
                            <select>
                                <option value="displayValue">Display value</option>
                                <option value="viewWebPage">View web page</option>
                                <option value="viewWikimedia" selected>View Wikimedia site</option>
                                <option value="compareCoordinates">Compare coordinates</option>
                                <option value="compareDates">Compare dates</option>
                                <option value="viewAllProperties">View all properties</option>
                                <option value="reconciliationSettings">Reconciliation settings</option>
                            </select>
                            <select>
                                <option value="view" selected>View</option>
                                <option value="maximize">Maximize</option>
                                <option value="close">Close</option>
                            </select>
                        </div>
                        <div class="component-header-bottom">
                            <div class="row">
                                <div class="bold-text">Project</div>
                                <select id="projectSelect">
                                    <option>Wikidocumentaries</option>
                                    <option>Wikipedia</option>
                                    <option>Wikimedia Commons</option>
                                    <option>Reasonator</option>
                                </select>
                                <select id="languageSelect">
                                    <option value="en" selected>English</option>
                                    <option value="fi">Finnish</option>
                                </select>
                            </div>
                            <div class="row">
                                <a id="projectUrl" href="#" target="_blank">Simple text</a>
                            </div>
                        </div>
                    </div>
                    <div class="component-body">
                        <iframe id="projectIframe" style="width: 100%; height: 100%; border: none;"></iframe>
                    </div>
                </div>
                <div class="component" id="rightcomponent">
                    <div class="component-header">
                        <div class="component-header-top">
                            <select>
                                <option value="displayValue">Display value</option>
                                <option value="viewWebPage">View web page</option>
                                <option value="viewWikimedia">View Wikimedia site</option>
                                <option value="compareCoordinates" selected>Compare coordinates</option>
                                <option value="compareDates">Compare dates</option>
                                <option value="viewAllProperties">View all properties</option>
                                <option value="reconciliationSettings">Reconciliation settings</option>
                            </select>
                            <select>
                                <option value="view" selected>View</option>
                                <option value="maximize">Maximize</option>
                                <option value="close">Close</option>
                            </select>
                        </div>
                        <div class="component-header-bottom">
                            <div class="row">
                            </div>
                        </div>
                    </div>
                    <div class="component-body">
                        <div id="map" style="width: 100%; height: 100%;"></div>
                    </div>
                </div>
                
            </div>
        </div>
    </div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="templates.js"></script>
    <script>
let map;
let markersLayer;

document.addEventListener('DOMContentLoaded', () => {
    initializeMap();

    const searchButton = document.getElementById('searchButton');
    const searchInput = document.getElementById('searchInput');

    searchButton.addEventListener('click', () => {
        const query = searchInput.value.trim();
        if (query) {
            populateItems(query);
        }
    });

    searchInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
            event.preventDefault();
            searchButton.click();
        }
    });

    document.getElementById('nextButton').addEventListener('click', showNextValue);
    document.getElementById('prevButton').addEventListener('click', showPreviousValue);

    document.addEventListener('keydown', (event) => {
        if (event.key === 'ArrowDown' || event.key === 'ArrowRight') {
            navigateItems('next');
        } else if (event.key === 'ArrowUp' || event.key === 'ArrowLeft') {
            navigateItems('previous');
        }
    });

    document.querySelectorAll('.component-header-top select').forEach(select => {
        select.addEventListener('change', (event) => {
            const selectedView = event.target.value;
            const component = event.target.closest('.component');
            if (selectedView === 'Close') {
                component.remove();
            } else {
                replaceComponentContent(component, selectedView);
            }
        });
    });

    // Add event listener for help button
    document.getElementById('showHelpButton').addEventListener('click', () => {
        const helpSection = document.getElementById('helpSection');
        if (helpSection.style.display === 'none') {
            helpSection.style.display = 'block';
            document.getElementById('showHelpButton').textContent = 'Hide Help';
        } else {
            helpSection.style.display = 'none';
            document.getElementById('showHelpButton').textContent = 'Show Help';
        }
    });
});

const SPREADSHEET_ID = 'your_spreadsheet_id'; // Update with your actual spreadsheet ID
const RANGE = 'Dataset!D2:D'; // Adjust range if necessary

async function loadSheetData() {
    const url = `/api/sheet-data?spreadsheetId=${SPREADSHEET_ID}&range=${RANGE}`;
    try {
        const response = await fetch(url);
        const data = await response.json();
        values = data.values ? data.values.map(row => row[0]) : [];
        currentIndex = 0;
        displayCurrentValue();
    } catch (error) {
        console.error('Error loading sheet data:', error);
    }
}

function displayCurrentValue() {
    const searchInput = document.getElementById('searchInput');
    if (values.length > 0) {
        searchInput.value = values[currentIndex];
    } else {
        searchInput.value = 'No data available';
    }
}

function showNextValue() {
    if (values.length > 0) {
        currentIndex = (currentIndex + 1) % values.length;
        displayCurrentValue();
    }
}

function showPreviousValue() {
    if (values.length > 0) {
        currentIndex = (currentIndex - 1 + values.length) % values.length;
        displayCurrentValue();
    }
}

function initializeMap() {
    map = L.map('map').setView([51.505, -0.09], 13);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
    }).addTo(map);

    // Use L.featureGroup for markers to enable getBounds()
    markersLayer = L.featureGroup().addTo(map);
}

async function fetchWikidataItems(query) {
    try {
        const sparqlQuery = `
            SELECT ?item ?itemLabel ?itemDescription (SAMPLE(?image) AS ?image) (SAMPLE(?coord) AS ?coord) WHERE {
                SERVICE wikibase:mwapi {
                    bd:serviceParam wikibase:endpoint "www.wikidata.org";
                                    wikibase:api "EntitySearch";
                                    mwapi:search "${query}";
                                    mwapi:language "en";
                                    mwapi:limit "8".
                    ?item wikibase:apiOutputItem mwapi:item.
                    ?item wikibase:apiOutputItemLabel mwapi:label.
                }
                OPTIONAL { ?item wdt:P18 ?image. }
                OPTIONAL { ?item wdt:P625 ?coord. }
                SERVICE wikibase:label { bd:serviceParam wikibase:language "[AUTO_LANGUAGE],en". }
            } GROUP BY ?item ?itemLabel ?itemDescription LIMIT 8`;
        const url = `https://query.wikidata.org/sparql?query=${encodeURIComponent(sparqlQuery)}&format=json`;
        const response = await fetch(url);
        const data = await response.json();
        return data.results.bindings;
    } catch (error) {
        console.error('Error fetching Wikidata items:', error);
        return [];
    }
}

function createItemElement(item) {
    const itemElement = document.createElement('div');
    itemElement.className = 'item';

    itemElement.addEventListener('click', () => {
        document.querySelectorAll('.item').forEach(el => el.classList.remove('selected'));
        itemElement.classList.add('selected');

        const qid = item.item.value.split('/').pop();
        const url = `https://wikidocumentaries-demo.wmcloud.org/${qid}`;

        const projectUrl = document.getElementById('projectUrl');
        if (projectUrl) {
            projectUrl.href = url;
            projectUrl.textContent = url;
        }

        const iframe = document.getElementById('projectIframe');
        if (iframe) {
            iframe.src = url;
            iframe.onload = () => {
                // Avoid cross-origin issues; skip iframe content manipulation
            };
        }
    });

    const img = document.createElement('img');
    img.src = item.image ? item.image.value : 'https://via.placeholder.com/50';
    img.alt = 'QID Image';

    const details = document.createElement('div');
    details.className = 'item-details';

    const label = document.createElement('span');
    label.style.fontWeight = 'bold';
    label.textContent = item.itemLabel.value + ' ';
    details.appendChild(label);

    const labelLink = document.createElement('a');
    labelLink.href = `https://www.wikidata.org/wiki/${item.item.value.split('/').pop()}`;
    labelLink.className = 'qid-link';
    labelLink.textContent = item.item.value.split('/').pop();
    labelLink.target = '_blank';
    details.appendChild(labelLink);

    const description = document.createElement('div');
    description.textContent = item.itemDescription ? item.itemDescription.value : 'No description available';
    details.appendChild(description);

    const button = document.createElement('button');
    button.textContent = 'Match';

    itemElement.appendChild(img);
    itemElement.appendChild(details);
    itemElement.appendChild(button);

    return itemElement;
}

function navigateItems(direction) {
    const items = Array.from(document.querySelectorAll('.item'));
    const selectedIndex = items.findIndex(item => item.classList.contains('selected'));

    if (selectedIndex === -1) return;

    let newIndex;
    if (direction === 'next') {
        newIndex = (selectedIndex + 1) % items.length;
    } else if (direction === 'previous') {
        newIndex = (selectedIndex - 1 + items.length) % items.length;
    }

    if (newIndex !== selectedIndex) {
        items[selectedIndex].classList.remove('selected');
        items[newIndex].classList.add('selected');
        items[newIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });

        items[newIndex].click();
    }
}

async function populateItems(query) {
    const itemList = document.getElementById('itemList');
    itemList.innerHTML = '';

    markersLayer.clearLayers();

    const items = await fetchWikidataItems(query);

    const markers = [];

    items.forEach((item, index) => {
        const itemElement = createItemElement(item);
        itemList.appendChild(itemElement);

        if (item.coord) {
            const coords = item.coord.value.replace('Point(', '').replace(')', '').split(' ');
            const lat = parseFloat(coords[1]);
            const lon = parseFloat(coords[0]);

            const imageUrl = item.image ? item.image.value : 'https://via.placeholder.com/100';
            const qid = item.item.value.split('/').pop();
            const popupContent = `
                <div style="text-align: center;">
                    <img src="${imageUrl}" alt="Image" style="width: 100px; height: 100px; object-fit: cover; border-radius: 5px;"/><br>
                    <strong>${item.itemLabel.value}</strong><br>
                    ${item.itemDescription ? item.itemDescription.value : 'No description available'}<br>
                    <a href="https://www.wikidata.org/wiki/${qid}" target="_blank" class="popup-link">${qid}</a>
                </div>
            `;
            const marker = L.marker([lat, lon]).bindPopup(popupContent);
            markers.push(marker);
        }

        if (index === 0) {
            itemElement.click();
        }
    });

    if (markers.length > 0) {
        markersLayer.addLayer(L.featureGroup(markers));
        map.fitBounds(markersLayer.getBounds());
    }
}

    if (markers.length > 0) {
        markersLayer.addLayer(L.featureGroup(markers));
        map.fitBounds(markersLayer.getBounds());
    }
    function addNewComponent(viewType) {
        const rightPane = document.querySelector('.right-pane');
        const newComponent = document.createElement('div');
        newComponent.className = 'component';
        newComponent.innerHTML = generateComponentHTML(viewType);
        rightPane.appendChild(newComponent);

        // Reinitialize map if compareCoordinates is selected
        if (viewType === 'compareCoordinates') {
            initializeMapInNewComponent(newComponent.querySelector('#map'));
        }
    }

    function replaceComponentContent(component, viewType) {
        const componentBody = component.querySelector('.component-body');
        componentBody.innerHTML = generateComponentBody(viewType);

        // Reinitialize map if compareCoordinates is selected
        if (viewType === 'compareCoordinates') {
            initializeMapInNewComponent(component.querySelector('#map'));
        }
    }

    function generateComponentHTML(viewType) {
        return `
            <div class="component-header">
                <div class="component-header-top">
                    <select>
                        <option value="displayValue" ${viewType === 'displayValue' ? 'selected' : ''}>Display value</option>
                        <option value="viewWebPage" ${viewType === 'viewWebPage' ? 'selected' : ''}>View web page</option>
                        <option value="viewWikimedia" ${viewType === 'viewWikimedia' ? 'selected' : ''}>View Wikimedia site</option>
                        <option value="compareCoordinates" ${viewType === 'compareCoordinates' ? 'selected' : ''}>Compare coordinates</option>
                        <option value="compareDates" ${viewType === 'compareDates' ? 'selected' : ''}>Compare dates</option>
                        <option value="viewAllProperties" ${viewType === 'viewAllProperties' ? 'selected' : ''}>View all properties</option>
                        <option value="reconciliationSettings" ${viewType === 'reconciliationSettings' ? 'selected' : ''}>Reconciliation settings</option>
                    </select>
                    <select>
                        <option>View</option>
                        <option>Maximize</option>
                        <option>Close</option>
                    </select>
                </div>
                <div class="component-header-bottom">
                    ${getTemplate(`${viewType}HeaderBottom`)}
                </div>
            </div>
            <div class="component-body">
                ${generateComponentBody(viewType)}
            </div>
        `;
    }

    function generateComponentBody(viewType) {
        switch (viewType) {
            case 'displayValue':
                return '<div>Display value component content</div>';
            case 'viewWebPage':
                return '<iframe src="https://example.com" style="width: 100%; height: 100%; border: none;"></iframe>';
            case 'viewWikimedia':
                return '<iframe src="https://www.wikimedia.org" style="width: 100%; height: 100%; border: none;"></iframe>';
            case 'compareCoordinates':
                return '<div id="map" style="width: 100%; height: 100%;"></div>';
            case 'compareDates':
                return '<div>Compare dates component content</div>';
            case 'viewAllProperties':
                return '<div>View all properties component content</div>';
            case 'reconciliationSettings':
                return '<div>Reconciliation settings component content</div>';
            default:
                return '<div>Dummy component content</div>';
        }
    }
    function initializeMapInNewComponent(mapContainer) {
        if (mapContainer) {
            const newMap = L.map(mapContainer).setView([51.505, -0.09], 13);

            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            }).addTo(newMap);

            L.featureGroup().addTo(newMap); // Add an empty feature group for markers
        }
    }
    // Function to replace the component content and header
    function replaceComponentContent(component, viewType) {
        const componentBody = component.querySelector('.component-body');
        const componentHeaderBottom = component.querySelector('.component-header-bottom');

        // Replace the component body with the appropriate content
        componentBody.innerHTML = generateComponentBody(viewType);

        // Replace the component-header-bottom with the specific options for the selected viewType
        componentHeaderBottom.innerHTML = getTemplate(`${viewType}HeaderBottom`);

        // Reinitialize map if compareCoordinates is selected
        if (viewType === 'compareCoordinates') {
            initializeMapInNewComponent(component.querySelector('#map'));
        }
    }

    // Sample function call for `viewWebPage` selection
    function onComponentSelect(viewType) {
        const component = document.querySelector('#component'); // Assume this is the container for the component

        replaceComponentContent(component, viewType);
    }

    // Example usage:
    // onComponentSelect('viewWebPage');

    </script>
</body>
</html>
